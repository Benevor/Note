## 第一章：历史简介

### 1. 数据库、大数据发展历史

数据库历史：

- 上世纪：开源关系型结构化数据库
- 2006年Google三驾马车：GFS、Bigtable、MapReduce开启了大数据时代
  - 大数据生态：Hadoop、Redis、MangoDB等**NoSQL**大数据生态 
- 2010年左右：**NewSQL**数据库、**云原生**数据库
- 2020年后：**HTAP**成为强需求

------

NoSQL数据库：

- 主要存储**非结构化**数据：KV，文本，图，时序数据、地理信息
- 大部分不支持事务，也就不符合OLTP场景的需求 

------

NewSQL数据库：

- 既支持事务、由兼容多种数据模型的可扩展需求

------

数据技术发展的驱动力

- 业务发展导致的数据容量增长
- 场景创新催生的“数据交互效率与数据模型多样性”需求
- 硬件与云计算的发展

------

### 2. 分布式关系型数据库的发展

分布式系统成为刚需的原因：系统承载的计算量的增长速度大于摩尔定律的预测，导致集中式系统不能满足需求

分布式意味着海量数据与计算

CAP理论：一致性、可用性、分区容忍性（分布式系统3选2）

分布式技术的主要挑战：

- 分治与协助
- 全局一致性
- 故障与容错
- 网络分区容错

------

分布式系统历史：

- 2006Google
  - GFS：分布式文件系统
  - Bigtable：分布式KV存储
  - MapReduce：分布式文件系统与分布式KV存储之上的分布式计算与分析

**NewSQL** = 分布式系统 + SQL + 事务 = 原生分布式关系型数据库

------

### 3. TiDB产品与开源社区

TiDB基础

- Google Spanner
- Google F1
- Raft

标签：NewSQL、HTAP、存储与计算分离等

迭代产品：

- TiSpark
- TiFlash：列式存储引擎，迈向HTAP

------



## 第二章：TiDB整体概述

### 1. 我们到底需要一个什么样的数据库

TiDB设计需求：

- 扩展性
- 强一致和高可用性
- 标准SQL，支持ACID事务
- 云原生：计算与存储的高度分离架构设计，使云场景中基于资源的弹性设计成为可能
- HTAP：海量数据下，OLTP与OLAP的融合；行列混合与资源隔离
- 兼容主流生态与协议

------

**数据技术栈领域常见基础因素：**

- 数据模型：关系模型、文档模型、KV模型
- 数据存储与检索结构：B-tree、LSM、分形树
- 数据格式：结构化数据、非结构化数据、半结构化数据
- 存储引擎：负责数据的存取和持久化（InnoDB、RocksDB）
- 复制协议与算法：Raft、Paxos
- 分布式事务模型：XA、Percolator
- 数据架构：多计算引擎共享数据、每个计算引擎都有一份数据
- 优化器算法：成本最低的执行计划
- 执行引擎：火山引擎、向量化、大规模并行计算
- 计算引擎：标准SQL引擎

------

计算与存储分离的高度分层架构：基于网络的发展

- TiDB-Server：计算引擎
- TiKV：分布式存储引擎
- PD：元信息管理、分布式事务ID分配、调度中心

------

### 2. 如何构建一个分布式存储系统

分布式存储系统设计

- 更细粒度的弹性扩缩容
- 支持高并发读写，尤其是写
- 数据不丢不错
- 多副本保障一致性和高可用
- 支持分布式事务

------

TiKV的选择

- 数据模型：KV索引
- 数据存储与检索结构：LSM
- 存储引擎：RocksDB，基于LSM，支持批量写入、支持无锁快照读（有利于数据副本迁移）
- 副本与复制：Raft（逻辑清晰，有利于工程化）（即在多个RocksDB基础上实现Raft）
- 扩展：
  - 常见分片算法：哈希、范围、列举
  - 选择Range算法（范围分片）
  - **Region**概念
- 多版本并发控制（MVCC）：在key后面增加版本号
  - 通过加锁来实现并发控制，会使得分布式系统的性能衰减
- 分布式事务
  - 去中心化的两阶段提交
- 协作处理器Coprocessor
  - 最大程度下推机制：在存储层尽量进行计算与预处理、比如数据的过滤和聚合
    - 减少节点之间网络交互成本
    - 充分利用分布式存储节点的并行计算能力
  - Coprocessor：TiKV中读取数据的计算模块
  - 每个TiKV存储节点都有一个协调计算器

架构图：

![TiKV架构图](..\image\TiKV架构图.png)

------

### 3. 如何构建一个分布式SQL计算引擎

这一小节大多数没有理解

SQL引擎的一般过程：

- SQL语句解析，生成结构化数据
- 逻辑优化：生成Logical plan
- 物理优化（优化器）：根据统计信息进一步优化，依据cost模型生成最佳执行计划
- 执行引擎：根据执行计划进行执行

分布式SQL引擎的主要优化策略：让数据在分布式存储层尽快完成过滤和预计算（最大下推）

------



## 第三章 新一代HTAP数据库选型

### 1. 基于分布式架构的HTAP